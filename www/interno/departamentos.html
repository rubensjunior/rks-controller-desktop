<!-- Wappler include head-page="backoffice.html" is="dmx-app" id="departamentos" appConnect="local" bootstrap5="local" capacitor="local" components="{dmxBootstrap5Offcanvas:{},dmxBootstrap5Modal:{},dmxDataTraversal:{},dmxBootstrap5TableGenerator:{}}" fontawesome_4="local" -->



<dmx-data-detail id="data_departamento" dmx-bind:data="listar_departamentos.data.query" key="dep_id"></dmx-data-detail>
<dmx-serverconnect id="listar_departamentos" url="http://localhost:3000/api/electron/cadastros/lista-departamentos" site="rks-controller" dmx-param:id_empresa="usuario_atual.data.query_usuario.empresa_selecionada"></dmx-serverconnect>

<dmx-serverconnect id="listar_membros" url="http://localhost:3000/api/electron/cadastros/listas-usuarios" site="rks-controller" dmx-param:id_empresa="usuario_atual.data.query_usuario.empresa_selecionada"></dmx-serverconnect>
<dmx-serverconnect id="lista_membros" noload="true" url="http://localhost:3000/api/electron/cadastros/listar_membros" site="rks-controller" dmx-param:id_departamento="data_departamento.data.dep_id"></dmx-serverconnect>
<div class="modal" id="modal_membros" is="dmx-bs5-modal" tabindex="-1" nocloseonclick="true" nokeyboard="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{data_departamento.data.nome_departamento}}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" dmx-on:click="form_membro.reset();data_departamento.select(0)"></button>
            </div>
            <div class="modal-body">
                <form id="form_membro" is="dmx-serverconnect-form" method="post" action="http://localhost:3000/api/electron/cadastros/criar-membro" site="rks-controller" dmx-on:error="notificacoes.danger('Ocorreu um erro: '+lastError.status+lastError.message+lastError.response)" dmx-on:success="lista_membros.load({id_departamento: data_departamento.data.dep_id});form_membro.reset();notificacoes.success(form_membro.data.resposta)">
                    <div class="form-group mb-3">
                        <input id="id_departamento" name="id_departamento" type="hidden" class="form-control" dmx-bind:value="data_departamento.data.dep_id">
                        <input id="id_empresa" name="id_empresa" type="hidden" class="form-control" dmx-bind:value="data_departamento.data.empresa_dep_ref"> <label for="input1" class="form-label">Colaborador</label>
                        <select id="select_membro" class="form-select py-2" dmx-bind:options="listar_membros.data.query_usuarios.data" optiontext="nome_completo" optionvalue="id_usuarios" name="select_membro">
                            <option value="">Selecione um membro</option>
                        </select>
                    </div>
                </form>
                <div class="container">
                    <div class="row">
                        <div class="col">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th class="titulo-tabela pb-3 bg-white">Nome completo</th>
                                        <th class="titulo-tabela pb-3 bg-white">Ações</th>
                                    </tr>
                                </thead>
                                <tbody is="dmx-repeat" dmx-generator="bs5table" dmx-bind:repeat="lista_membros.data.query_membros.data" id="tableRepeat1">
                                    <tr>
                                        <td dmx-text="nome_completo" class="py-3 texto-tabela"></td>
                                        <td class="py-3 texto-tabela"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal" dmx-on:click="form_membro.reset();data_departamento.select(0)">Cancelar</button>
                <button type="button" class="btn btn-primary" dmx-on:click="form_membro.submit()">Adicionar</button>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="modal_departamento" is="dmx-bs5-modal" tabindex="-1" nocloseonclick="true" nokeyboard="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cadastro de departamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" dmx-on:click="form_departamento.reset()"></button>
            </div>
            <div class="modal-body">
                <form id="form_departamento" is="dmx-serverconnect-form" method="post" action="http://localhost:3000/api/electron/cadastros/criar-departamento" site="rks-controller" dmx-on:error="notificacoes.danger('Ocorreu um erro: '+lastError.status+lastError.message+lastError.response)" dmx-on:success="listar_departamentos.load({id_empresa: usuario_atual.data.query_usuario.empresa_selecionada});form_departamento.reset();modal_departamento.hide();notificacoes.success('Departamento cadastrado com sucesso!')">
                    <div class="form-group mb-3"> <label for="nome_departamento_ipt" class="form-label">Nome do departamento</label>
                        <input type="text" class="form-control py-2" id="nome_departamento_ipt" name="nome_departamento_ipt" aria-describedby="input1_help">
                        <input id="empresa_dep_ref" name="empresa_dep_ref" type="hidden" class="form-control" dmx-bind:value="usuario_atual.data.query_usuario.empresa_selecionada">
                    </div>
                    <div class="form-group mb-3"> <label for="input2" class="form-label">Descrição</label>
                        <textarea id="descricao_departamento_ipt" class="form-control" name="descricao_departamento_ipt"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" dmx-on:click="form_departamento.reset();modal_departamento.hide()">Cancelar</button>
                <button type="button" class="btn btn-primary" dmx-on:click="form_departamento.submit()">Cadastrar</button>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="modal_editar_departamento" is="dmx-bs5-modal" tabindex="-1" nocloseonclick="true" nokeyboard="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Atualização de departamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" dmx-on:click="form_editar_departamento.reset();data_departamento.select(0);modal_editar_departamento.hide()"></button>
            </div>
            <div class="modal-body">
                <form id="form_editar_departamento" is="dmx-serverconnect-form" method="post" action="http://localhost:3000/api/electron/cadastros/atualizar-departamento" site="rks-controller" dmx-on:error="notificacoes.danger('Ocorreu um erro: '+lastError.status+lastError.message+lastError.response)" dmx-on:success="listar_departamentos.load({id_empresa: usuario_atual.data.query_usuario.empresa_selecionada});data_departamento.select(0);form_editar_departamento.reset();modal_editar_departamento.hide();notificacoes.success('Departamento atualizado com sucesso!')">
                    <div class="form-group mb-3"> <label for="editar_nome_departamento_ipt" class="form-label">Nome do departamento</label>
                        <input type="text" class="form-control py-2" id="editar_nome_departamento_ipt" name="editar_nome_departamento_ipt" aria-describedby="input1_help" dmx-bind:value="data_departamento.data.nome_departamento">
                        <input id="id_departamento" name="id_departamento" type="hidden" class="form-control" dmx-bind:value="data_departamento.data.dep_id">
                    </div>
                    <div class="form-group mb-3"> <label for="input2" class="form-label">Descrição</label>
                        <textarea id="editar_descricao_departamento_ipt" class="form-control" name="editar_descricao_departamento_ipt" dmx-bind:value="data_departamento.data.descricao_departamento"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" dmx-on:click="form_editar_departamento.reset();data_departamento.select(0);modal_editar_departamento.hide()">Cancelar</button>
                <button type="button" class="btn btn-primary" dmx-on:click="form_editar_departamento.submit()">Atualizar cadastro</button>
            </div>
        </div>
    </div>
</div>
<header class="my-5">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col">
                <h4 class="m-0 mb-1">Departamentos</h4>
            </div>
            <div class="col text-end">
                <button id="btn1" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal_departamento">Adicionar&nbsp;</button>
            </div>
        </div>
    </div>
</header>
<div class="container-fluid">
    <div class="row">
        <div class="col p-4 rounded-3 bg-white">
            <table class="table">
                <thead>
                    <tr>
                        <th class="titulo-tabela pb-3 bg-white">Nome departamento</th>
                        <th class="titulo-tabela pb-3 bg-white">Descricao departamento</th>
                        <th class="titulo-tabela pb-3 bg-white text-end">Ações</th>
                    </tr>
                </thead>
                <tbody is="dmx-repeat" dmx-generator="bs5table" dmx-bind:repeat="listar_departamentos.data.query" id="tableRepeat2" key="dep_id">
                    <tr>
                        <td dmx-text="nome_departamento" class="py-3 texto-tabela"></td>
                        <td dmx-text="descricao_departamento" class="py-3 texto-tabela-secundario"></td>
                        <td class="py-3 texto-tabela-secundario text-end">
                            <div class="dropdown">
                                <button id="dropdown1" class="btn dropdown-toggle btn-sm btn-light" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Ações&nbsp;</button>
                                <div class="dropdown-menu" aria-labelledby="dropdown1">
                                    <button id="btn2" class="btn w-100 text-start text-primary" data-bs-target="#modal_editar_departamento" data-bs-toggle="modal" dmx-on:click="data_departamento.select(dep_id)">Editar</button>
                                    <button id="btn4" class="btn w-100 text-start text-secondary" data-bs-target="#modal_membros" data-bs-toggle="modal" dmx-on:click="run([{run:{outputType:'text',action:`data_departamento.select(dep_id)`}},{wait:{delay:400}},{run:{outputType:'text',action:`lista_membros.load({id_departamento: data_departamento.data.dep_id})`}}])">Adicionar membro</button>
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>